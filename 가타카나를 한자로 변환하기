# katakana_to_kanji.py
import re
import sys
from jamdict import Jamdict
import MeCab

jam = Jamdict()
tagger = MeCab.Tagger("-Ochasen")

katakana_re = re.compile(r'^[ァ-ヶー]+$')  # 가타카나 범위 정규식

def lookup_kanji_candidates(reading):
    """Jamdict에서 카타카나 읽기로 한자 후보 찾기"""
    result = jam.lookup(reading)
    candidates = []
    entries = getattr(result, 'entries', getattr(result, 'entry_list', []))
    for ent in entries:
        for k in getattr(ent, 'k_ele', []):
            if getattr(k, 'keb', None):
                candidates.append(k.keb)
    # 중복 제거
    uniq = []
    seen = set()
    for c in candidates:
        if c not in seen:
            uniq.append(c)
            seen.add(c)
    return uniq

def convert_katakana_sentence(sentence, prefer_first=True, user_dict=None):
    if user_dict is None:
        user_dict = {}

    node = tagger.parseToNode(sentence)
    out_tokens = []
    while node:
        surface = node.surface
        if not surface:
            node = node.next
            continue

        # 사용자 사전 우선
        if surface in user_dict:
            out_tokens.append(user_dict[surface])
            node = node.next
            continue

        # 카타카나면 변환 시도
        if katakana_re.match(surface):
            candidates = lookup_kanji_candidates(surface)
            if candidates:
                out_tokens.append(candidates[0] if prefer_first else f"{candidates}")
            else:
                out_tokens.append(surface)
        else:
            out_tokens.append(surface)
        node = node.next
    return ''.join(out_tokens)

if __name__ == "__main__":
    examples = [
        "ニホンゴヲベンキョウシマス",   # 日本語を勉強します
        "トウキョウハキレイデス",     # 東京は綺麗です
        "カンジヲヨメマスカ",         # 漢字を読めますか
    ]

    # 자주 쓰는 단어를 사전에 등록
    user_dict = {
        "ニホンゴ": "日本語",
        "ベンキョウ": "勉強",
        "トウキョウ": "東京",
        "カンジ": "漢字",
    }

    for s in examples:
        print("원문:", s)
        print("변환:", convert_katakana_sentence(s, prefer_first=True, user_dict=user_dict))
        print("-" * 40)

    # 커맨드라인 입력 지원
    if len(sys.argv) > 1:
        inp = sys.argv[1]
        print("입력:", inp)
        print("출력:", convert_katakana_sentence(inp, user_dict=user_dict))
